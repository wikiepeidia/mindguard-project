name: Pylint

on:
  push:
    branches: [ main, "feature/**" ]
  pull_request:
    branches: [ main ]

jobs:
  analyze:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    concurrency:
      group: "pylint-${{ github.ref }}"
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install linter dependencies
        run: |
          python -m pip install --upgrade pip
          # Use a Pylint version compatible with Python 3.10/3.11
          python -m pip install 'pylint==2.17.7' pylint-json2html

      - name: Gather Python files to lint
        id: files
        run: |
          files=$(git ls-files '*.py' | grep -vE '^(.git|backup|data|saved_models|uploads|models|static|ui/dist|tests?|DOCUMENTS|app.py|core/auth.py)' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run pylint (errors only)
        if: steps.files.outputs.files != ''
        run: |
          echo "Running pylint over the collected Python files..."
          echo "$FILES"
          # Convert file list to arguments
          args=( ${{ steps.files.outputs.files }} )
          # Run only errors & fatal to keep linting useful on CI
          pylint -E -j 1 --rcfile=.github/.pylintrc "${args[@]}" || true
          # Also produce a JSON report for inspection (don't fail the step on warnings)
          pylint -j 1 --rcfile=.github/.pylintrc --output-format=json "${args[@]}" > pylint_report.json || true

      - name: Convert JSON to HTML
        if: always() && steps.files.outputs.files != ''
        run: |
          if [ -f pylint_report.json ]; then
            python -m json.tool pylint_report.json > pylint_report_pretty.json || true
            pylint-json2html -f pylint_report.json -o pylint_report.html || true
          fi

      - name: Upload pylint report
        uses: actions/upload-artifact@v4
        if: steps.files.outputs.files != ''
        with:
          name: pylint-report
          path: |
            pylint_report.json
            pylint_report_pretty.json
            pylint_report.html

      - name: Show message if no files to lint
        if: steps.files.outputs.files == ''
        run: echo "No Python files found for linting."