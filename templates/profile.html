{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <!-- Header -->
            <div class="text-center mb-5" data-aos="fade-down">
                <h2 class="fw-bold text-white">Hồ sơ cá nhân</h2>
                <p class="text-muted">Quản lý thông tin và kết quả đánh giá năng lực</p>
            </div>

            <div class="row g-4">
                <!-- Cột Trái: Thông tin cá nhân -->
                <div class="col-md-5" data-aos="fade-right">
                    <div class="glass-card h-100 text-center">
                        <div class="position-relative d-inline-block mb-3">
                            <div class="bg-gradient-primary rounded-circle p-1">
                                <img src="https://ui-avatars.com/api/?name={{ user.name }}&background=06b6d4&color=fff&size=128" class="rounded-circle border border-4 border-dark" alt="Avatar">
                            </div>
                            <span class="position-absolute bottom-0 end-0 bg-success border border-dark rounded-circle p-2"></span>
                        </div>
                        
                        <h4 class="text-white fw-bold mb-1">{{ user.name }}</h4>
                        <p class="text-info small mb-3">{{ user.email }}</p>
                        
                        <hr class="border-secondary opacity-25 my-4">
                        
                        <div class="text-start px-3">
                            <div class="mb-3">
                                <label class="text-muted small fw-bold text-uppercase">Ngày tham gia</label>
                                <div class="text-white">{{ user.created_at.strftime('%d/%m/%Y') }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small fw-bold text-uppercase">Nghề nghiệp</label>
                                <div class="text-white">{{ user.occupation or 'Chưa cập nhật' }}</div>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small fw-bold text-uppercase">Thành phố</label>
                                <div class="text-white">{{ user.city or 'Chưa cập nhật' }}</div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button class="btn btn-outline-light w-100 rounded-pill" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                                <i class="fas fa-edit me-2"></i> Chỉnh sửa hồ sơ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Cột Phải: Kết quả bài Test -->
                <div class="col-md-7" data-aos="fade-left">
                    <div class="glass-card h-100">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="text-white fw-bold mb-0"><i class="fas fa-award me-2 text-warning"></i>Kết quả Test IQ Lừa đảo</h5>
                            
                            {% if quiz_result %}
                                <span class="badge bg-success bg-opacity-20 text-success border border-success px-3">Đã hoàn thành</span>
                            {% else %}
                                <span class="badge bg-secondary bg-opacity-20 text-secondary border border-secondary px-3">Chưa kiểm tra</span>
                            {% endif %}
                        </div>

                        {% if quiz_result %}
                            <div class="text-center py-4">
                                <div class="display-1 fw-bold text-white mb-2">{{ quiz_result.score }}<span class="fs-4 text-muted">/{{ quiz_result.max_score }}</span></div>
                                <p class="text-muted">Điểm số an toàn của bạn</p>
                                
                                <div class="progress bg-dark mb-4" style="height: 10px;">
                                    {% set percent = (quiz_result.score / quiz_result.max_score) * 100 %}
                                    <div class="progress-bar bg-gradient-{{ 'success' if percent >= 80 else 'warning' if percent >= 50 else 'danger' }}" 
                                         role="progressbar" style="width: {{ percent }}%"></div>
                                </div>

                                {% if quiz_result.certificate_code %}
                                    <div class="alert alert-success bg-success bg-opacity-10 border-success d-flex align-items-center mb-4 text-start">
                                        <i class="fas fa-certificate fa-2x me-3 text-success"></i>
                                        <div>
                                            <div class="fw-bold text-white">Chứng nhận An toàn</div>
                                            <div class="small text-success-emphasis">Mã số: {{ quiz_result.certificate_code }}</div>
                                        </div>
                                    </div>
                                    
                                    <!-- NÚT SỬA LỖI Ở ĐÂY: Đổi main.certificate thành quiz.certificate -->
                                    <a href="{{ url_for('quiz.certificate') }}" class="btn btn-warning w-100 py-3 fw-bold shadow-lg">
                                        <i class="fas fa-download me-2"></i> XEM CHỨNG NHẬN
                                    </a>
                                {% else %}
                                    <div class="alert alert-warning bg-warning bg-opacity-10 border-warning text-start">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Bạn chưa đạt điểm tối thiểu để nhận chứng chỉ.
                                    </div>
                                    <a href="{{ url_for('quiz.quiz') }}" class="btn btn-primary w-100">
                                        <i class="fas fa-redo me-2"></i> Làm lại bài test
                                    </a>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-clipboard-list fa-4x text-muted mb-3 opacity-50"></i>
                                <h5 class="text-white">Bạn chưa thực hiện bài kiểm tra nào</h5>
                                <p class="text-muted mb-4">Hãy kiểm tra kiến thức để biết mình có an toàn trên mạng không nhé!</p>
                                <a href="{{ url_for('quiz.quiz') }}" class="btn btn-primary px-5 rounded-pill">
                                    Bắt đầu ngay <i class="fas fa-arrow-right ms-2"></i>
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Chỉnh sửa -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-white">Cập nhật thông tin</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('auth.edit_profile') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-muted small">Họ và tên</label>
                        <input type="text" class="form-control" name="name" value="{{ user.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Ngày sinh</label>
                        <input type="date" class="form-control" name="date_of_birth" value="{{ user.date_of_birth }}" style="color-scheme: dark;">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Thành phố</label>
                        <input type="text" class="form-control" name="city" value="{{ user.city }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Số điện thoại</label>
                        <input type="text" class="form-control" name="phone_number" value="{{ user.phone_number or '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Giới thiệu ngắn</label>
                        <textarea class="form-control" name="bio" rows="3">{{ user.bio or '' }}</textarea>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}